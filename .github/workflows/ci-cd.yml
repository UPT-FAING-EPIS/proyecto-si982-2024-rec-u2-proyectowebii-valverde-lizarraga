name: Construcción y Despliegue de Infraestructura en Azure

env:
  AZURE_WEBAPP_NAME: proyecto-awa-326  # Nombre de la aplicación en Azure
  DOTNET_VERSION: '8'             # Versión de .NET

on:
  push:
    branches: [ "main" ]
    paths:
      - 'GestionReservasWebII/**'
      - 'infra/**'  # Cambios en Terraform
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  

jobs:
  deploy_infra:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout del código'
        uses: actions/checkout@v4

      - name: 'Login a Azure'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Configurar Terraform'
        uses: hashicorp/setup-terraform@v3

      - name: 'Inicializar Terraform'
        run: |
          cd infra
          terraform init 

      - name: 'Validar configuración Terraform'
        run: |
          cd infra
          terraform validate -no-color

      - name: 'Plan de Infraestructura Terraform'
        run: |
          cd infra
          terraform plan -var="SUBSCRIPTION_ID=${{ secrets.SUBSCRIPTION_ID }}" \
                        -var="sqladmin_username=${{ secrets.SQL_USER }}" \
                        -var="sqladmin_password=${{ secrets.SQL_PASS }}" \
                        -no-color -out main.tfplan

      - name: 'Aplicar Infraestructura Terraform'
        run: |
          cd infra
          terraform apply -auto-approve main.tfplan

  deploy_app:
    runs-on: ubuntu-latest
    needs: deploy_infra
    steps:
      - name: 'Checkout del código'
        uses: actions/checkout@v4

      - name: 'Login a GitHub Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: 'Construir y Subir Imagen Docker'
        run: |
          docker build ./src --tag ghcr.io/jeanvalverde24/shorten:${{ github.sha }}
          docker push ghcr.io/jeanvalverde24/shorten:${{ github.sha }}

      - name: 'Desplegar en Azure Web App'
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          images: ghcr.io/jeanvalverde24/shorten:${{ github.sha }}
